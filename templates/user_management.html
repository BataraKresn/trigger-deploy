{% extends "base.html" %}

{% block title %}User Management - Trigger Deploy{% endblock %}
{% block description %}Manage users, roles, and permissions{% endblock %}

{% set current_page = "users" %}
{% set show_nav = true %}
{% set show_footer = true %}

{% block nav_controls %}
<button id="addUserBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
    <i class="fas fa-plus mr-1"></i>Add User
</button>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-users mr-3 text-blue-500"></i>
            User Management
        </h1>
        <p class="text-gray-600 mt-2">Manage users, roles, and permissions for your system</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Users -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-blue-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Users</p>
                    <p class="text-3xl font-bold text-gray-900" id="totalUsers">
                        <i class="fas fa-spinner fa-spin text-blue-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Active Users -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-green-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Active Users</p>
                    <p class="text-3xl font-bold text-gray-900" id="activeUsers">
                        <i class="fas fa-spinner fa-spin text-green-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-check text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Pending Users -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-yellow-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Pending</p>
                    <p class="text-3xl font-bold text-gray-900" id="pendingUsers">
                        <i class="fas fa-spinner fa-spin text-yellow-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-clock text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Admin Users -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-purple-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Administrators</p>
                    <p class="text-3xl font-bold text-gray-900" id="adminUsers">
                        <i class="fas fa-spinner fa-spin text-purple-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-shield text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-xl p-6 shadow-sm mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <!-- Search -->
                <div class="relative">
                    <input type="text" id="userSearch" placeholder="Search users..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- Role Filter -->
                <select id="roleFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Roles</option>
                    <option value="admin">Administrator</option>
                    <option value="user">User</option>
                    <option value="viewer">Viewer</option>
                </select>

                <!-- Status Filter -->
                <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                </select>
            </div>

            <button id="exportUsers" class="mt-3 sm:mt-0 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                <i class="fas fa-download mr-1"></i>Export
            </button>
        </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-table mr-2 text-blue-500"></i>
                Users List
            </h3>
        </div>
        
        <!-- Table Container -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Loading state -->
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex justify-center items-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-3"></div>
                                <span class="text-gray-600">Loading users...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="bg-white px-6 py-3 flex items-center justify-between border-t border-gray-200">
            <div class="flex-1 flex justify-between sm:hidden">
                <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </button>
                <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span id="showingStart" class="font-medium">1</span> to 
                        <span id="showingEnd" class="font-medium">10</span> of 
                        <span id="totalCount" class="font-medium">0</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div id="pageNumbers" class="inline-flex">
                            <!-- Page numbers will be generated here -->
                        </div>
                        <button id="nextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Add New User</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="userForm" class="space-y-4">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="userName" name="name" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="userEmail" name="email" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="userRole" class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="userRole" name="role" required 
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Role</option>
                        <option value="admin">Administrator</option>
                        <option value="user">User</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                
                <div id="passwordField">
                    <label for="userPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="userPassword" name="password" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Leave blank to keep current password (when editing)</p>
                </div>
                
                <div class="flex items-center justify-end space-x-3 pt-4">
                    <button type="button" id="cancelBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                        <i class="fas fa-save mr-1"></i>Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_subtitle %}User and role management{% endblock %}

{% block extra_js %}
<script>
    class UserManagement {
        constructor() {
            this.users = [];
            this.currentPage = 1;
            this.itemsPerPage = 10;
            this.totalItems = 0;
            this.filters = {
                search: '',
                role: '',
                status: ''
            };
            this.editingUserId = null;
            this.init();
        }

        // Utility function for making authenticated requests
        async authenticatedFetch(url, options = {}) {
            const defaultOptions = {
                credentials: 'include', // Include session cookies
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest', // Mark as AJAX request
                    ...options.headers
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                
                // Handle authentication errors
                if (response.status === 401) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return null;
                }
                
                return response;
            } catch (error) {
                console.error('Network error:', error);
                showNotification('Network error occurred', 'error');
                return null;
            }
        }

        async init() {
            await this.loadUsers();
            this.setupEventListeners();
        }

        async loadUsers() {
            try {
                const params = new URLSearchParams({
                    page: this.currentPage,
                    limit: this.itemsPerPage,
                    search: this.filters.search,
                    role: this.filters.role,
                    status: this.filters.status
                });

                const response = await this.authenticatedFetch(`/api/users?${params}`);
                if (!response) return; // Error already handled in authenticatedFetch
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.users = data.users || [];
                this.totalItems = data.total || 0;
                
                this.renderUsers();
                this.updateSummary();
                this.updatePagination();
                updateLastUpdated();
                
            } catch (error) {
                console.error('Failed to load users:', error);
                this.showMockData();
            }
        }

        showMockData() {
            // Show mock data while API is not available
            this.users = [
                {
                    id: 1,
                    name: 'John Doe',
                    email: 'john@example.com',
                    role: 'admin',
                    status: 'active',
                    last_login: '2024-01-20T10:30:00Z',
                    created_at: '2023-12-01T09:00:00Z'
                },
                {
                    id: 2,
                    name: 'Jane Smith',
                    email: 'jane@example.com',
                    role: 'user',
                    status: 'active',
                    last_login: '2024-01-19T15:45:00Z',
                    created_at: '2024-01-15T11:20:00Z'
                },
                {
                    id: 3,
                    name: 'Mike Johnson',
                    email: 'mike@example.com',
                    role: 'viewer',
                    status: 'pending',
                    last_login: null,
                    created_at: '2024-01-20T14:10:00Z'
                }
            ];
            this.totalItems = this.users.length;
            
            this.renderUsers();
            this.updateSummary();
            this.updatePagination();
        }

        renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            if (!this.users || this.users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600 text-lg font-medium">No users found</p>
                            <p class="text-gray-500 text-sm">Add a user to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const usersHTML = this.users.map(user => this.renderUserRow(user)).join('');
            tbody.innerHTML = usersHTML;
        }

        renderUserRow(user) {
            const statusBadge = this.getStatusBadge(user.status);
            const roleBadge = this.getRoleBadge(user.role);
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-white font-semibold">
                                    ${user.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.name}</div>
                                <div class="text-sm text-gray-500">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${roleBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${user.last_login ? this.formatDate(user.last_login) : 'Never'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${this.formatDate(user.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="userManagement.editUser(${user.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="userManagement.deleteUser(${user.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        getStatusBadge(status) {
            const badges = {
                active: '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>',
                inactive: '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Inactive</span>',
                pending: '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>'
            };
            return badges[status] || badges.inactive;
        }

        getRoleBadge(role) {
            const badges = {
                admin: '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800"><i class="fas fa-shield-alt mr-1"></i>Admin</span>',
                user: '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800"><i class="fas fa-user mr-1"></i>User</span>',
                viewer: '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800"><i class="fas fa-eye mr-1"></i>Viewer</span>'
            };
            return badges[role] || badges.viewer;
        }

        updateSummary() {
            const total = this.totalItems;
            const active = this.users.filter(u => u.status === 'active').length;
            const pending = this.users.filter(u => u.status === 'pending').length;
            const admin = this.users.filter(u => u.role === 'admin').length;

            document.getElementById('totalUsers').textContent = total;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('pendingUsers').textContent = pending;
            document.getElementById('adminUsers').textContent = admin;
        }

        updatePagination() {
            const totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
            const startItem = ((this.currentPage - 1) * this.itemsPerPage) + 1;
            const endItem = Math.min(this.currentPage * this.itemsPerPage, this.totalItems);

            document.getElementById('showingStart').textContent = startItem;
            document.getElementById('showingEnd').textContent = endItem;
            document.getElementById('totalCount').textContent = this.totalItems;

            // Enable/disable pagination buttons
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = this.currentPage === 1;
            nextBtn.disabled = this.currentPage >= totalPages;
            
            prevBtn.classList.toggle('opacity-50', this.currentPage === 1);
            nextBtn.classList.toggle('opacity-50', this.currentPage >= totalPages);
        }

        formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch {
                return 'Invalid date';
            }
        }

        setupEventListeners() {
            // Add user button
            document.getElementById('addUserBtn').addEventListener('click', () => {
                this.openModal();
            });

            // Search and filters
            document.getElementById('userSearch').addEventListener('input', (e) => {
                this.filters.search = e.target.value;
                this.currentPage = 1;
                this.loadUsers();
            });

            document.getElementById('roleFilter').addEventListener('change', (e) => {
                this.filters.role = e.target.value;
                this.currentPage = 1;
                this.loadUsers();
            });

            document.getElementById('statusFilter').addEventListener('change', (e) => {
                this.filters.status = e.target.value;
                this.currentPage = 1;
                this.loadUsers();
            });

            // Modal events
            document.getElementById('closeModal').addEventListener('click', () => {
                this.closeModal();
            });

            document.getElementById('cancelBtn').addEventListener('click', () => {
                this.closeModal();
            });

            // Form submission
            document.getElementById('userForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveUser();
            });

            // Pagination
            document.getElementById('prevPage').addEventListener('click', () => {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadUsers();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
                if (this.currentPage < totalPages) {
                    this.currentPage++;
                    this.loadUsers();
                }
            });
        }

        openModal(user = null) {
            this.editingUserId = user ? user.id : null;
            
            document.getElementById('modalTitle').textContent = user ? 'Edit User' : 'Add New User';
            document.getElementById('userModal').classList.remove('hidden');
            
            if (user) {
                document.getElementById('userName').value = user.name || '';
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userRole').value = user.role || '';
                document.getElementById('userPassword').required = false;
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('userPassword').required = true;
            }
        }

        closeModal() {
            document.getElementById('userModal').classList.add('hidden');
            this.editingUserId = null;
            document.getElementById('userForm').reset();
        }

        async saveUser() {
            const formData = new FormData(document.getElementById('userForm'));
            const userData = Object.fromEntries(formData.entries());
            
            try {
                const url = this.editingUserId ? `/api/users/${this.editingUserId}` : '/api/users';
                const method = this.editingUserId ? 'PUT' : 'POST';
                
                const response = await this.authenticatedFetch(url, {
                    method,
                    body: JSON.stringify(userData)
                });
                
                if (!response) return; // Error already handled in authenticatedFetch
                
                if (response.ok) {
                    this.closeModal();
                    await this.loadUsers();
                    showNotification(this.editingUserId ? 'User updated successfully' : 'User created successfully', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to save user', 'error');
                }
            } catch (error) {
                console.error('Save user error:', error);
                showNotification('Network error occurred', 'error');
            }
        }

        editUser(userId) {
            const user = this.users.find(u => u.id === userId);
            if (user) {
                this.openModal(user);
            }
        }

        async deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }
            
            try {
                const response = await this.authenticatedFetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (!response) return; // Error already handled in authenticatedFetch
                
                if (response.ok) {
                    await this.loadUsers();
                    showNotification('User deleted successfully', 'success');
                } else {
                    showNotification('Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Delete user error:', error);
                showNotification('Network error occurred', 'error');
            }
        }
    }

    // Initialize user management
    let userManagement;
    document.addEventListener('DOMContentLoaded', function() {
        userManagement = new UserManagement();
    });
</script>
{% endblock %}
