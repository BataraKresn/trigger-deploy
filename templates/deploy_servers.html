{% extends "base.html" %}

{% block title %}Deploy Servers - Trigger Deploy{% endblock %}
{% block description %}Deploy applications and services to your servers{% endblock %}

{% set current_page = "deploy" %}
{% set show_nav = true %}
{% set show_footer = true %}

{% block nav_controls %}
<button id="refreshServersBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
    <i class="fas fa-sync-alt mr-1"></i>Refresh
</button>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-rocket mr-3 text-green-500"></i>
            Deploy to Servers
        </h1>
        <p class="text-gray-600 mt-2">Deploy applications and services to your configured servers</p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 border-l-4 border-green-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Servers</p>
                    <p class="text-3xl font-bold text-gray-900" id="totalServers">
                        <i class="fas fa-spinner fa-spin text-green-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border-l-4 border-blue-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Active Servers</p>
                    <p class="text-3xl font-bold text-gray-900" id="activeServers">
                        <i class="fas fa-spinner fa-spin text-blue-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border-l-4 border-purple-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Deployments Today</p>
                    <p class="text-3xl font-bold text-gray-900" id="deploymentsToday">
                        <i class="fas fa-spinner fa-spin text-purple-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-rocket text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border-l-4 border-orange-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Success Rate</p>
                    <p class="text-3xl font-bold text-gray-900" id="successRate">
                        <i class="fas fa-spinner fa-spin text-orange-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Selection and Deploy Form -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Deploy Form -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-rocket mr-2 text-green-500"></i>
                        Deploy Application
                    </h2>
                </div>
                <div class="p-6">
                    <form id="deployForm" class="space-y-4">
                        <div>
                            <label for="serverSelect" class="block text-sm font-medium text-gray-700 mb-2">Server</label>
                            <select id="serverSelect" name="server" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Select a server...</option>
                            </select>
                        </div>

                        <div>
                            <label for="serviceSelect" class="block text-sm font-medium text-gray-700 mb-2">Service/Application</label>
                            <select id="serviceSelect" name="service" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Select a service...</option>
                            </select>
                        </div>

                        <div>
                            <label for="branchInput" class="block text-sm font-medium text-gray-700 mb-2">Branch/Version</label>
                            <input type="text" id="branchInput" name="branch" value="main" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="forceDeployCheck" name="force" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                            <label for="forceDeployCheck" class="ml-2 block text-sm text-gray-700">Force deployment (skip checks)</label>
                        </div>

                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                            <i class="fas fa-rocket mr-2"></i>
                            Deploy Now
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Server List -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-server mr-2 text-blue-500"></i>
                        Available Servers
                    </h2>
                </div>
                <div class="p-6">
                    <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Loading state -->
                        <div class="col-span-full flex justify-center items-center py-12">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto mb-4"></div>
                                <p class="text-gray-600">Loading servers...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Deployments -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-history mr-2 text-purple-500"></i>
                Recent Deployments
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Server</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="deploymentsTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                            <p>Loading deployment history...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Deploy Progress Modal -->
<div id="deployModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-rocket mr-2 text-green-500"></i>
                    Deployment Progress
                </h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="deployProgress" class="space-y-4">
                <!-- Progress will be shown here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_subtitle %}Server deployment and management{% endblock %}

{% block extra_js %}
<script>
    class DeployManager {
        constructor() {
            this.servers = [];
            this.services = [];
            this.deployments = [];
            this.init();
        }

        // Utility function for making authenticated requests
        async authenticatedFetch(url, options = {}) {
            const defaultOptions = {
                credentials: 'include', // Include session cookies
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest', // Mark as AJAX request
                    ...options.headers
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                
                // Handle authentication errors
                if (response.status === 401) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return null;
                }
                
                return response;
            } catch (error) {
                console.error('Network error:', error);
                showNotification('Network error occurred', 'error');
                return null;
            }
        }

        async init() {
            await this.loadServers();
            await this.loadServices();
            await this.loadDeployments();
            this.setupEventListeners();
        }

        async loadServers() {
            try {
                const response = await this.authenticatedFetch('/api/servers');
                if (response && response.ok) {
                    const data = await response.json();
                    this.servers = data.servers || [];
                    this.populateServerSelect();
                    this.renderServersGrid();
                    this.updateStats();
                }
            } catch (error) {
                console.error('Failed to load servers:', error);
                this.showMockServers();
            }
        }

        async loadServices() {
            try {
                const response = await this.authenticatedFetch('/api/services');
                if (response && response.ok) {
                    const data = await response.json();
                    this.services = data.services || [];
                    this.populateServiceSelect();
                }
            } catch (error) {
                console.error('Failed to load services:', error);
                this.showMockServices();
            }
        }

        async loadDeployments() {
            try {
                const response = await this.authenticatedFetch('/api/deployments/recent');
                if (response && response.ok) {
                    const data = await response.json();
                    this.deployments = data.deployments || [];
                    this.renderDeploymentsTable();
                }
            } catch (error) {
                console.error('Failed to load deployments:', error);
                this.showMockDeployments();
            }
        }

        showMockServers() {
            this.servers = [
                {
                    id: 'prod-web-01',
                    name: 'Production Web Server 01',
                    host: '192.168.1.100',
                    status: 'online',
                    services: ['web-app', 'api'],
                    last_deployment: '2025-07-22T10:30:00Z'
                },
                {
                    id: 'prod-db-01',
                    name: 'Production Database Server',
                    host: '192.168.1.101',
                    status: 'online',
                    services: ['database'],
                    last_deployment: '2025-07-20T14:20:00Z'
                },
                {
                    id: 'staging-01',
                    name: 'Staging Environment',
                    host: '192.168.1.200',
                    status: 'maintenance',
                    services: ['web-app', 'api', 'database'],
                    last_deployment: '2025-07-22T09:15:00Z'
                }
            ];
            this.populateServerSelect();
            this.renderServersGrid();
            this.updateStats();
        }

        showMockServices() {
            this.services = [
                { id: 'web-app', name: 'Web Application', type: 'frontend' },
                { id: 'api', name: 'REST API', type: 'backend' },
                { id: 'database', name: 'Database Migration', type: 'database' },
                { id: 'worker', name: 'Background Worker', type: 'service' }
            ];
            this.populateServiceSelect();
        }

        showMockDeployments() {
            this.deployments = [
                {
                    id: 1,
                    server: 'prod-web-01',
                    service: 'web-app',
                    status: 'success',
                    timestamp: '2025-07-22T10:30:00Z',
                    duration: '2m 34s',
                    branch: 'main'
                },
                {
                    id: 2,
                    server: 'staging-01',
                    service: 'api',
                    status: 'failed',
                    timestamp: '2025-07-22T09:45:00Z',
                    duration: '1m 12s',
                    branch: 'develop'
                },
                {
                    id: 3,
                    server: 'prod-db-01',
                    service: 'database',
                    status: 'success',
                    timestamp: '2025-07-20T14:20:00Z',
                    duration: '5m 18s',
                    branch: 'main'
                }
            ];
            this.renderDeploymentsTable();
        }

        populateServerSelect() {
            const select = document.getElementById('serverSelect');
            select.innerHTML = '<option value="">Select a server...</option>';
            
            this.servers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;
                option.textContent = server.name;
                option.disabled = server.status !== 'online';
                select.appendChild(option);
            });
        }

        populateServiceSelect() {
            const select = document.getElementById('serviceSelect');
            select.innerHTML = '<option value="">Select a service...</option>';
            
            this.services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.name;
                select.appendChild(option);
            });
        }

        renderServersGrid() {
            const grid = document.getElementById('serversGrid');
            
            if (!this.servers || this.servers.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-server text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg font-medium">No servers configured</p>
                    </div>
                `;
                return;
            }

            const serversHTML = this.servers.map(server => this.renderServerCard(server)).join('');
            grid.innerHTML = serversHTML;
        }

        renderServerCard(server) {
            const statusColor = this.getStatusColor(server.status);
            const statusIcon = this.getStatusIcon(server.status);
            const safeStatus = (server.status || 'unknown').toString();
            
            return `
                <div class="border rounded-lg p-4 hover:shadow-md transition duration-200 ${server.status !== 'online' ? 'opacity-75' : ''}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 ${statusColor.bg} rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-server ${statusColor.text}"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${server.name || 'Unknown Server'}</h3>
                                <p class="text-sm text-gray-500">${server.host || server.ip || 'Unknown Host'}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor.badge}">
                            <i class="fas ${statusIcon} mr-1"></i>${safeStatus.toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Services:</span>
                            <span class="text-gray-900">${server.services ? server.services.length : 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Last Deploy:</span>
                            <span class="text-gray-900">${this.formatDate(server.last_deployment)}</span>
                        </div>
                    </div>
                    
                    <button onclick="deployManager.quickDeploy('${server.id}')" 
                            class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm font-medium transition duration-200 ${server.status !== 'online' ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${server.status !== 'online' ? 'disabled' : ''}>
                        <i class="fas fa-rocket mr-1"></i>Quick Deploy
                    </button>
                </div>
            `;
        }

        renderDeploymentsTable() {
            const tbody = document.getElementById('deploymentsTableBody');
            
            if (!this.deployments || this.deployments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-rocket text-4xl text-gray-300 mb-4"></i>
                            <p>No recent deployments</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const deploymentsHTML = this.deployments.map(deployment => this.renderDeploymentRow(deployment)).join('');
            tbody.innerHTML = deploymentsHTML;
        }

        renderDeploymentRow(deployment) {
            const statusBadge = this.getDeploymentStatusBadge(deployment.status);
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${deployment.server}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${deployment.service}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${this.formatDate(deployment.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${deployment.duration}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deployManager.viewLogs(${deployment.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button onclick="deployManager.redeploy(${deployment.id})" class="text-green-600 hover:text-green-900">
                            <i class="fas fa-redo"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        updateStats() {
            const total = this.servers.length;
            const active = this.servers.filter(s => s.status === 'online').length;
            const deploymentsToday = this.deployments.filter(d => {
                const today = new Date().toDateString();
                return new Date(d.timestamp).toDateString() === today;
            }).length;
            const successRate = this.deployments.length > 0 ? 
                Math.round((this.deployments.filter(d => d.status === 'success').length / this.deployments.length) * 100) : 100;

            document.getElementById('totalServers').textContent = total;
            document.getElementById('activeServers').textContent = active;
            document.getElementById('deploymentsToday').textContent = deploymentsToday;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        setupEventListeners() {
            // Deploy form submission
            document.getElementById('deployForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.deployApplication();
            });

            // Refresh servers button
            document.getElementById('refreshServersBtn').addEventListener('click', () => {
                this.loadServers();
                showNotification('Servers refreshed', 'success');
            });

            // Close modal
            document.getElementById('closeModal').addEventListener('click', () => {
                this.closeModal();
            });
        }

        async deployApplication() {
            const formData = new FormData(document.getElementById('deployForm'));
            const deployData = Object.fromEntries(formData.entries());
            
            if (!deployData.server || !deployData.service) {
                showNotification('Please select both server and service', 'error');
                return;
            }

            this.showModal();
            
            try {
                const response = await fetch('/api/deploy/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(deployData)
                });

                if (response.ok) {
                    const result = await response.json();
                    this.showDeployProgress(result);
                    await this.loadDeployments(); // Refresh deployment history
                } else {
                    const error = await response.json();
                    showNotification(`Deployment failed: ${error.message}`, 'error');
                    this.closeModal();
                }
            } catch (error) {
                console.error('Deploy error:', error);
                showNotification('Network error during deployment', 'error');
                this.closeModal();
            }
        }

        showModal() {
            document.getElementById('deployModal').classList.remove('hidden');
            document.getElementById('deployProgress').innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mr-4"></div>
                    <div>
                        <p class="font-medium text-gray-900">Starting deployment...</p>
                        <p class="text-sm text-gray-600">Please wait while we deploy your application</p>
                    </div>
                </div>
            `;
        }

        closeModal() {
            document.getElementById('deployModal').classList.add('hidden');
        }

        showDeployProgress(result) {
            const progressDiv = document.getElementById('deployProgress');
            progressDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-check text-green-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">Deployment Started</p>
                            <p class="text-sm text-gray-600">ID: ${result.deployment_id || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <pre class="text-sm text-gray-700 whitespace-pre-wrap">${result.message || 'Deployment initiated successfully'}</pre>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="deployManager.closeModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
        }

        quickDeploy(serverId) {
            const serverSelect = document.getElementById('serverSelect');
            serverSelect.value = serverId;
            
            const serviceSelect = document.getElementById('serviceSelect');
            if (serviceSelect.options.length > 1) {
                serviceSelect.selectedIndex = 1; // Select first available service
            }
            
            // Scroll to form
            document.getElementById('deployForm').scrollIntoView({ behavior: 'smooth' });
        }

        viewLogs(deploymentId) {
            window.open(`/logs/deployment/${deploymentId}`, '_blank');
        }

        redeploy(deploymentId) {
            const deployment = this.deployments.find(d => d.id === deploymentId);
            if (deployment) {
                document.getElementById('serverSelect').value = deployment.server;
                document.getElementById('serviceSelect').value = deployment.service;
                document.getElementById('branchInput').value = deployment.branch || 'main';
                
                document.getElementById('deployForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        getStatusColor(status) {
            const colors = {
                online: { bg: 'bg-green-100', text: 'text-green-600', badge: 'bg-green-100 text-green-800' },
                offline: { bg: 'bg-red-100', text: 'text-red-600', badge: 'bg-red-100 text-red-800' },
                maintenance: { bg: 'bg-yellow-100', text: 'text-yellow-600', badge: 'bg-yellow-100 text-yellow-800' }
            };
            return colors[status] || colors.offline;
        }

        getStatusIcon(status) {
            const icons = {
                online: 'fa-check-circle',
                offline: 'fa-times-circle',
                maintenance: 'fa-tools'
            };
            return icons[status] || 'fa-question-circle';
        }

        getDeploymentStatusBadge(status) {
            const badges = {
                success: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>Success</span>',
                failed: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-times mr-1"></i>Failed</span>',
                running: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"><i class="fas fa-spinner fa-spin mr-1"></i>Running</span>',
                pending: '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>Pending</span>'
            };
            return badges[status] || badges.pending;
        }

        formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
                
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch {
                return 'Invalid date';
            }
        }
    }

    // Initialize deploy manager
    let deployManager;
    document.addEventListener('DOMContentLoaded', function() {
        deployManager = new DeployManager();
    });
</script>
{% endblock %}
