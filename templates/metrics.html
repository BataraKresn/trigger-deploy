{% extends "base.html" %}

{% block title %}Metrics Dashboard - Trigger Deploy{% endblock %}
{% block description %}Real-time metrics and analytics for your infrastructure{% endblock %}

{% set current_page = "metrics" %}
{% set show_nav = true %}
{% set show_footer = true %}

{% block nav_controls %}
<select id="timeRange" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="1h">Last Hour</option>
    <option value="6h" selected>Last 6 Hours</option>
    <option value="24h">Last 24 Hours</option>
    <option value="7d">Last 7 Days</option>
</select>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-chart-bar mr-3 text-blue-500"></i>
            Metrics Dashboard
        </h1>
        <p class="text-gray-600 mt-2">Real-time metrics and analytics for your infrastructure</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Requests -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-blue-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Requests</p>
                    <p class="text-3xl font-bold text-gray-900" id="totalRequests">
                        <i class="fas fa-spinner fa-spin text-blue-500"></i>
                    </p>
                    <p class="text-xs text-blue-600 mt-1">+12% from yesterday</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-globe text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Response Time -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-green-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Avg Response Time</p>
                    <p class="text-3xl font-bold text-gray-900" id="avgResponseTime">
                        <i class="fas fa-spinner fa-spin text-green-500"></i>
                    </p>
                    <p class="text-xs text-green-600 mt-1">-5ms from yesterday</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-tachometer-alt text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Error Rate -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-yellow-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Error Rate</p>
                    <p class="text-3xl font-bold text-gray-900" id="errorRate">
                        <i class="fas fa-spinner fa-spin text-yellow-500"></i>
                    </p>
                    <p class="text-xs text-yellow-600 mt-1">+0.1% from yesterday</p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Uptime -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-purple-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">System Uptime</p>
                    <p class="text-3xl font-bold text-gray-900" id="systemUptime">
                        <i class="fas fa-spinner fa-spin text-purple-500"></i>
                    </p>
                    <p class="text-xs text-purple-600 mt-1">99.9% this month</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Request Traffic Chart -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                    Request Traffic
                </h3>
            </div>
            <div class="p-6">
                <div class="relative">
                    <canvas id="trafficChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Response Time Chart -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-clock mr-2 text-green-500"></i>
                    Response Times
                </h3>
            </div>
            <div class="p-6">
                <div class="relative">
                    <canvas id="responseTimeChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Service Performance -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-server mr-2 text-purple-500"></i>
                    Service Performance
                </h3>
            </div>
            <div class="p-6">
                <div class="relative">
                    <canvas id="serviceChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Error Distribution -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                    Error Distribution
                </h3>
            </div>
            <div class="p-6">
                <div class="relative">
                    <canvas id="errorChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Stats -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-activity mr-2 text-indigo-500"></i>
                Real-time Activity
            </h3>
        </div>
        <div class="p-6">
            <div id="realtimeStats" class="space-y-4">
                <!-- Real-time stats will be loaded here -->
                <div class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading real-time data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_subtitle %}Performance metrics and analytics{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    class MetricsDashboard {
        constructor() {
            this.charts = {};
            this.timeRange = '6h';
            this.refreshInterval = null;
            this.init();
        }

        // Utility function for making authenticated requests
        async authenticatedFetch(url, options = {}) {
            const defaultOptions = {
                credentials: 'include', // Include session cookies
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest', // Mark as AJAX request
                    ...options.headers
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                
                // Handle authentication errors
                if (response.status === 401) {
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return null;
                }
                
                return response;
            } catch (error) {
                console.error('Network error:', error);
                showNotification('Network error occurred', 'error');
                return null;
            }
        }

        async init() {
            await this.loadMetrics();
            this.setupCharts();
            this.setupEventListeners();
            this.startAutoRefresh();
        }

        async loadMetrics() {
            try {
                const response = await this.authenticatedFetch(`/api/metrics?range=${this.timeRange}`);
                if (!response) return; // Error already handled
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.updateSummaryCards(data);
                this.updateCharts(data);
                updateLastUpdated();
                
            } catch (error) {
                console.error('Failed to load metrics:', error);
                this.showMockData();
            }
        }

        showMockData() {
            // Show mock data while API is not available
            const mockData = {
                summary: {
                    totalRequests: '12,543',
                    avgResponseTime: '145ms',
                    errorRate: '0.3%',
                    uptime: '99.9%'
                },
                traffic: this.generateMockTimeSeriesData('requests'),
                responseTime: this.generateMockTimeSeriesData('responseTime'),
                services: this.generateMockServiceData(),
                errors: this.generateMockErrorData()
            };

            this.updateSummaryCards(mockData);
            this.updateCharts(mockData);
        }

        updateSummaryCards(data) {
            const summary = data.summary || {};
            
            document.getElementById('totalRequests').textContent = summary.totalRequests || '0';
            document.getElementById('avgResponseTime').textContent = summary.avgResponseTime || '0ms';
            document.getElementById('errorRate').textContent = summary.errorRate || '0%';
            document.getElementById('systemUptime').textContent = summary.uptime || '0%';
        }

        setupCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            };

            // Traffic Chart
            const trafficCtx = document.getElementById('trafficChart').getContext('2d');
            this.charts.traffic = new Chart(trafficCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests per minute',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: chartOptions
            });

            // Response Time Chart
            const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
            this.charts.responseTime = new Chart(responseCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: chartOptions
            });

            // Service Performance Chart
            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            this.charts.service = new Chart(serviceCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(168, 85, 247)',
                            'rgb(249, 115, 22)',
                            'rgb(239, 68, 68)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Error Chart
            const errorCtx = document.getElementById('errorChart').getContext('2d');
            this.charts.error = new Chart(errorCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Error Count',
                        data: [],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ]
                    }]
                },
                options: chartOptions
            });
        }

        updateCharts(data) {
            // Update traffic chart
            if (data.traffic && this.charts.traffic) {
                this.charts.traffic.data.labels = data.traffic.labels || [];
                this.charts.traffic.data.datasets[0].data = data.traffic.values || [];
                this.charts.traffic.update();
            }

            // Update response time chart
            if (data.responseTime && this.charts.responseTime) {
                this.charts.responseTime.data.labels = data.responseTime.labels || [];
                this.charts.responseTime.data.datasets[0].data = data.responseTime.values || [];
                this.charts.responseTime.update();
            }

            // Update service performance chart
            if (data.services && this.charts.service) {
                this.charts.service.data.labels = data.services.labels || [];
                this.charts.service.data.datasets[0].data = data.services.values || [];
                this.charts.service.update();
            }

            // Update error chart
            if (data.errors && this.charts.error) {
                this.charts.error.data.labels = data.errors.labels || [];
                this.charts.error.data.datasets[0].data = data.errors.values || [];
                this.charts.error.update();
            }
        }

        generateMockTimeSeriesData(type) {
            const now = new Date();
            const labels = [];
            const values = [];
            const points = 20;

            for (let i = points - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 5 * 60000); // 5 minutes intervals
                labels.push(time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                
                if (type === 'requests') {
                    values.push(Math.floor(Math.random() * 100) + 50);
                } else if (type === 'responseTime') {
                    values.push(Math.floor(Math.random() * 50) + 100);
                }
            }

            return { labels, values };
        }

        generateMockServiceData() {
            return {
                labels: ['Web Server', 'Database', 'Cache', 'Queue', 'API'],
                values: [35, 25, 15, 15, 10]
            };
        }

        generateMockErrorData() {
            return {
                labels: ['4xx Errors', '5xx Errors', 'Timeouts', 'Network'],
                values: [12, 3, 2, 1]
            };
        }

        setupEventListeners() {
            // Time range selector
            document.getElementById('timeRange').addEventListener('change', (e) => {
                this.timeRange = e.target.value;
                this.loadMetrics();
            });
        }

        startAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
            }
            
            this.refreshInterval = setInterval(() => {
                this.loadMetrics();
            }, 60000); // 1 minute
        }
    }

    // Initialize metrics dashboard
    let metricsDashboard;
    document.addEventListener('DOMContentLoaded', function() {
        metricsDashboard = new MetricsDashboard();
    });
</script>
{% endblock %}
