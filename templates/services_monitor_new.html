{% extends "base.html" %}

{% block title %}Services Monitor - Trigger Deploy{% endblock %}
{% block description %}Real-time monitoring of all your services and infrastructure{% endblock %}

{% set current_page = "monitor" %}
{% set show_nav = true %}
{% set show_footer = true %}

{% block nav_controls %}
<button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
    <i class="fas fa-sync-alt mr-1"></i>Refresh
</button>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-chart-line mr-3 text-blue-500"></i>
            Services Monitor
        </h1>
        <p class="text-gray-600 mt-2">Real-time monitoring of all your services and infrastructure</p>
    </div>

    <!-- Controls -->
    <div class="mb-8 bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div class="flex items-center mb-3 sm:mb-0">
                <input type="checkbox" id="autoRefreshToggle" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2">
                <label for="autoRefreshToggle" class="text-sm font-medium text-gray-700">
                    <i class="fas fa-sync-alt mr-1"></i>Auto Refresh (30s)
                </label>
            </div>
            <div class="text-sm text-gray-500">
                <i class="fas fa-clock mr-1"></i>
                Last updated: <span id="lastUpdated">--:--:--</span>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Services -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-blue-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Services</p>
                    <p class="text-3xl font-bold text-gray-900" id="totalServices">
                        <i class="fas fa-spinner fa-spin text-blue-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Healthy Services -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-green-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Healthy Services</p>
                    <p class="text-3xl font-bold text-gray-900" id="healthyServices">
                        <i class="fas fa-spinner fa-spin text-green-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Issues -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-yellow-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Issues</p>
                    <p class="text-3xl font-bold text-gray-900" id="issueServices">
                        <i class="fas fa-spinner fa-spin text-yellow-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Critical Down -->
        <div class="bg-white rounded-xl p-6 border-l-4 border-red-500 shadow-sm hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Critical Down</p>
                    <p class="text-3xl font-bold text-gray-900" id="criticalServices">
                        <i class="fas fa-spinner fa-spin text-red-500"></i>
                    </p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-times-circle text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Services Grid -->
    <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-list-ul mr-2"></i>Service Status
        </h2>
        <div id="servicesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loading State -->
            <div class="col-span-full flex justify-center items-center py-12">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading services...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Events -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-history mr-2 text-blue-500"></i>
                Recent Events
            </h3>
        </div>
        <div class="p-6">
            <div id="recentEvents" class="space-y-4">
                <!-- Recent events will be loaded here -->
                <div class="flex items-center text-gray-500">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span class="text-sm">No recent events to display</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_subtitle %}Service monitoring and health checks{% endblock %}

{% block extra_js %}
<script>
    class ServiceMonitor {
        constructor() {
            this.services = [];
            this.autoRefresh = true;
            this.refreshInterval = null;
            this.init();
        }

        async init() {
            await this.loadServices();
            this.setupEventListeners();
            this.startAutoRefresh();
        }

        async loadServices() {
            try {
                const response = await fetch('/api/services/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.services = [
                    ...(data.local_services || []),
                    ...(data.remote_services || [])
                ];
                
                this.renderServices();
                this.updateSummary();
                updateLastUpdated();
                
            } catch (error) {
                console.error('Failed to load services:', error);
                this.showError('Failed to load service status. Please check your connection.');
            }
        }

        renderServices() {
            const container = document.getElementById('servicesContainer');
            
            if (!this.services || this.services.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-server text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg font-medium">No services configured</p>
                        <p class="text-gray-500 text-sm">Add services to your configuration to start monitoring</p>
                        <a href="/docs" class="inline-block mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200">
                            <i class="fas fa-book mr-2"></i>View Documentation
                        </a>
                    </div>
                `;
                return;
            }

            const servicesHTML = this.services.map(service => this.renderServiceCard(service)).join('');
            container.innerHTML = servicesHTML;
        }

        renderServiceCard(service) {
            const status = this.getServiceStatus(service);
            const { color, bgColor, icon } = this.getStatusStyles(status);
            const isCritical = service.critical && status !== 'healthy';
            
            return `
                <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition duration-200 ${isCritical ? 'border-2 border-red-200 bg-red-50' : 'border border-gray-200'}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 ${bgColor} rounded-lg flex items-center justify-center text-white mr-3">
                                <i class="fas ${this.getServiceIcon(service)} ${isCritical ? 'animate-pulse' : ''}"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${service.name || 'Unknown Service'}</h3>
                                <p class="text-sm text-gray-500">${service.description || 'No description'}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${color}">
                            <i class="fas ${icon} mr-1"></i>${status.toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        ${service.url ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600">URL:</span>
                                <span class="font-mono text-xs text-gray-900 truncate max-w-32">${service.url}</span>
                            </div>
                        ` : ''}
                        
                        ${service.port ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600">Port:</span>
                                <span class="text-gray-900">${service.port}</span>
                            </div>
                        ` : ''}
                        
                        ${service.response_time ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600">Response Time:</span>
                                <span class="text-gray-900">${service.response_time}${typeof service.response_time === 'number' ? 'ms' : ''}</span>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between">
                            <span class="text-gray-600">Last Check:</span>
                            <span class="text-gray-900">${this.formatTimestamp(service.timestamp)}</span>
                        </div>
                        
                        ${service.critical ? `
                            <div class="flex justify-between">
                                <span class="text-red-600">Priority:</span>
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium">Critical</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${service.message && status !== 'healthy' ? `
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                ${service.message}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <button onclick="serviceMonitor.checkService('${service.name}')" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                            <i class="fas fa-sync-alt mr-1"></i>Check Now
                        </button>
                    </div>
                </div>
            `;
        }

        getServiceStatus(service) {
            if (service.status) {
                const status = service.status.toLowerCase();
                if (['running', 'up', 'healthy', 'online'].includes(status)) return 'healthy';
                if (['down', 'stopped', 'error', 'failed', 'unhealthy', 'offline'].includes(status)) return 'unhealthy';
            }
            
            if (service.response_time !== undefined && service.response_time > 0) return 'healthy';
            return 'unknown';
        }

        getStatusStyles(status) {
            switch (status) {
                case 'healthy':
                    return {
                        color: 'bg-green-100 text-green-700',
                        bgColor: 'bg-green-500',
                        icon: 'fa-check-circle'
                    };
                case 'unhealthy':
                    return {
                        color: 'bg-red-100 text-red-700',
                        bgColor: 'bg-red-500',
                        icon: 'fa-times-circle'
                    };
                default:
                    return {
                        color: 'bg-gray-100 text-gray-700',
                        bgColor: 'bg-gray-500',
                        icon: 'fa-question-circle'
                    };
            }
        }

        getServiceIcon(service) {
            if (service.icon) return service.icon;
            if (service.type === 'docker') return 'fa-docker';
            if (service.url || service.type === 'http') return 'fa-globe';
            return 'fa-server';
        }

        updateSummary() {
            const total = this.services.length;
            const healthy = this.services.filter(s => this.getServiceStatus(s) === 'healthy').length;
            const unhealthy = this.services.filter(s => this.getServiceStatus(s) === 'unhealthy').length;
            const critical = this.services.filter(s => s.critical && this.getServiceStatus(s) !== 'healthy').length;

            document.getElementById('totalServices').textContent = total;
            document.getElementById('healthyServices').textContent = healthy;
            document.getElementById('issueServices').textContent = unhealthy;
            document.getElementById('criticalServices').textContent = critical;
        }

        async checkService(serviceName) {
            try {
                const response = await fetch(`/api/services/check/${encodeURIComponent(serviceName)}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await this.loadServices(); // Refresh all services
                    showNotification(`Service ${serviceName} checked successfully`, 'success');
                } else {
                    showNotification(`Failed to check service ${serviceName}`, 'error');
                }
            } catch (error) {
                console.error('Service check failed:', error);
                showNotification(`Network error checking service ${serviceName}`, 'error');
            }
        }

        formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleTimeString();
            } catch {
                return 'Invalid';
            }
        }

        startAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
            }
            
            if (this.autoRefresh) {
                this.refreshInterval = setInterval(() => {
                    if (this.autoRefresh) {
                        this.loadServices();
                    }
                }, 30000); // 30 seconds
            }
        }

        setupEventListeners() {
            // Auto-refresh toggle
            const autoRefreshToggle = document.getElementById('autoRefreshToggle');
            autoRefreshToggle.addEventListener('change', (e) => {
                this.autoRefresh = e.target.checked;
                this.startAutoRefresh();
            });

            // Manual refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                this.loadServices();
                showNotification('Services refreshed', 'success');
            });
        }

        showError(message) {
            console.error(message);
            showNotification(message, 'error');
        }
    }

    // Initialize service monitor
    let serviceMonitor;
    document.addEventListener('DOMContentLoaded', function() {
        serviceMonitor = new ServiceMonitor();
    });
</script>
{% endblock %}
